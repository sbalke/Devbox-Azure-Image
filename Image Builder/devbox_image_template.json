{
    "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
    "contentVersion": "1.0.0.0",
    "parameters": {
        "publisher": {
            "type": "string",
            "defaultValue": "microsoftvisualstudio"
        },
        "offer": {
            "type": "string",
            "defaultValue": "visualstudioplustools"
        },
        "sku": {
            "type": "string",
            "defaultValue": "vs-2022-pro-general-win11-m365-gen2"
        },
        "version": {
            "type": "string",
            "defaultValue": "latest",
            "metadata": {
                "description": "Version of the image, can be found with PowerShell: Get-AzVMImage -Location eastus -PublisherName MicrosoftWindowsDesktop -Offer windows-10 -Skus 19h1-evd"
            }
        },
        "galleryID": {
            "type": "string",
            "metadata": {
                "description": "The id of the share"
            }
        },
        "galleryimageID": {
            "type": "string"
        },
        "randomGUID": {
            "type": "string",
            "defaultValue": "[newGuid()]"
        }
    },
    "variables": {
        "imageTemplateName": "[concat('AIB_Devbox_',uniqueString('deployment().name',parameters('randomGUID')))]"
    },
    "resources": [
        {
            "name": "[variables('imageTemplateName')]",
            "type": "Microsoft.VirtualMachineImages/imageTemplates",
            "apiVersion": "2022-02-14",
            "location": "eastus",
            "dependsOn": [
            ],
            "tags": {
            },
            "identity": {
                "type": "UserAssigned",
                "userAssignedIdentities": {
                    "/subscriptions/1c3e9cd3-5139-4478-b55b-8c632168518e/resourcegroups/DevBoxes/providers/Microsoft.ManagedIdentity/userAssignedIdentities/DevBox-ManagedID": {}
                }
            },
            "properties": {
                "vmProfile": {
                    "vmSize": "Standard_DS1_v2",
                    "osDiskSizeGB": 128,
                    "userAssignedIdentities": []
                },
                "source": {
                    "type": "PlatformImage",
                    "publisher": "[parameters('publisher')]",
                    "offer": "[parameters('offer')]",
                    "sku": "[parameters('sku')]",
                    "version": "[parameters('version')]"
                },
                "customize": [
                    {
                        "type": "PowerShell",
                        "name": "createbuildfolder",
                        "runElevated": true,
                        "scriptUri": "https://raw.githubusercontent.com/sbalke/Devbox-Azure-Image/main/Image%20Builder/createArtifactFolder.ps1"
                    },
                    {
                        "type": "PowerShell",
                        "name": "InstallWinget",
                        "runElevated": true,
                        "scriptUri": "https://raw.githubusercontent.com/sbalke/Devbox-Azure-Image/main/Image%20Builder/installwinget.ps1"
                    },
                    {
                        "type": "WindowsRestart",
                        "restartCommand": "shutdown /r /f /t 0",
                        "restartCheckCommand": "echo Azure-Image-Builder-Restarted-the-VM > c:\\buildArtifacts\\azureImageBuilderRestart.txt",
                        "restartTimeout": "5m"

                    },
                    {
                        "type": "PowerShell",
                        "name": "InstallDockerDesktop",
                        "scriptUri": "https://raw.githubusercontent.com/sbalke/Devbox-Azure-Image/main/Image%20Builder/installDocker.ps1",
                        "runElevated": true
                    },
                    {
                        "type": "WindowsRestart",
                        "restartCommand": "shutdown /r /f /t 0",
                        "restartCheckCommand": "echo Azure-Image-Builder-Restarted-the-VM > c:\\buildArtifacts\\azureImageBuilderRestart.txt",
                        "restartTimeout": "5m"

                    },
                    {
                        "type": "PowerShell",
                        "name": "InstallNotepadplusplus",
                        "scriptUri": "https://raw.githubusercontent.com/sbalke/Devbox-Azure-Image/main/Image%20Builder/installNotepadplusplus.ps1",
                        "runElevated": true
                    },
                    {
                        "type": "WindowsRestart",
                        "restartCommand": "shutdown /r /f /t 0",
                        "restartCheckCommand": "echo Azure-Image-Builder-Restarted-the-VM > c:\\buildArtifacts\\azureImageBuilderRestart.txt",
                        "restartTimeout": "5m"

                    },
                    {
                        "type": "PowerShell",
                        "name": "InstallSSMS",
                        "scriptUri": "https://raw.githubusercontent.com/sbalke/Devbox-Azure-Image/main/Image%20Builder/installSSMS.ps1",
                        "runElevated": true
                    },
                    {
                        "type": "WindowsRestart",
                        "restartCommand": "shutdown /r /f /t 0",
                        "restartCheckCommand": "echo Azure-Image-Builder-Restarted-the-VM > c:\\buildArtifacts\\azureImageBuilderRestart.txt",
                        "restartTimeout": "5m"

                    },
                    {
                        "type": "WindowsUpdate",
                        "filters": [
                            "exclude:$_.Title -like '*Preview*'",
                            "include:$true"
                        ],
                        "searchCriteria": "IsInstalled=0",
                        "updateLimit": 20
                    },
                    {
                        "type": "WindowsRestart",
                        "restartCommand": "shutdown /r /f /t 0",
                        "restartCheckCommand": "echo Azure-Image-Builder-Restarted-the-VM > c:\\buildArtifacts\\azureImageBuilderRestart.txt",
                        "restartTimeout": "5m"

                    }

                ],
                "distribute": [
                    {
                        "type": "SharedImage",
                        "galleryImageId": "[parameters('galleryID')]",
                        "location": "eastus",
                        "imageId": "[parameters('galleryimageId')]",
                        "runOutputName": "runOutputSharedImage",
                        "replicationRegions": [
                            "eastus"
                        ],
                        "artifactTags": {
                            "base_image_publisher": "[parameters('publisher')]",
                            "base_image_offer": "[parameters('offer')]",
                            "base_image_sku": "[parameters('sku')]"
                        }
                    }
                ]
            }
        }

    ]
}